04. CloudFormation

## 04\. 템플릿(블루프린트)기반 CloudFormation

### 01\. CloudFormation 소개

#### 01. CloudForamtion 이란? 
​ AWS JIML보다 훨씬 편리한 도구인 'CloudFormation' 서비스를 제공한다. AWS의 CloudFormation은 일종의 구성 관리 서비스이다. JSON 포맷의 인프라 구성에 대한 기술(descript)을 '템플릿' 이라 하고 개념적으로 '블루프린트'라고 부른다. CloudFormation 서비스는 이 블루프린트를 해석하여 인프라를 구축한다. API, CLI 그리고 SDK는 인프라 구축에 어떤 액션(Action)이 어떤 순서로 어떻게 실행되어야 하는 것을 직접적으로 설명하는 액션에대한 기술이었다. 하지만, CloudFormation의 템플릿은 구체적 액션의 기술이 아닌 인프라가 어떻게 보일 것인지 그리고 어떻게 연결될 것인가에 대해서만 기술한다.
​ CloudForamtion 템플릿으로 생성된 인프라(리소스 조합)를 '스택(Stack)' 이라 부른다. 스택이 삭제되면 인프라를 구성하고 있던 리소스들도 모두 삭제된다. 그리고 템플릿이 업데이트 되면 그 템플릿으로 생성된 스택들도 자동으로 업데이트 된다. 어떤 인프라를 구성하는 EC2 인스턴스 1000개의 사이즈를 동시에 변경해야 한다고 생각해 보면, CloudForamttion는 장점을 바로 알 수 있다. CloudFormation의 장점들을 정리하면 다음과 같다. 

1. 인프라 설명의 일관된 방법
2. 의존성 처리
3. 복제
4. 커스터마이징
5. 사전 테스팅
6. 업데이트 용이
7. 문서화
8. 무료

​ CloudFormation 작업은 다음 순서대로 통상 이루어 진다.
1. 인프라 아키턱처 설계
2. 템플릿 JSON 파일 작성
3. AWS 콘솔 또는 CLI에서 템플릿으로 스택 생성

#### 02\. Template 작성
1. 템플릿의 기본 구조
   ```json
   {
   		"AWSTemplateFormatVersion": "2010-09-09",
		"Description": "",
		"Parameters": {

		},
		"Resources": {

		},
		"Outputs": {

		}
   }
   ```
   - AWSTemplateFormatVersion
     템플릿 형식에 대한 버젼이다. 이 버전이 맞지 않으면 스택 생성 중 에러가 난다. 최신 버젼(2020년 기준)은 '2010-09-09' 이며 유일하다. 
   - Description
     템플릿에 대한 설명이다.
   - Parameters
     템플릿에서 사용되는 파라미터들의 이름과 값의 타입(자료형)을 기술한다. 기본값을 기술할 때 세팅하기도 하지만 외부로 부터 세팅될 수도 있다. 예를 들면 도메인 이름, 데이터베이스 비밀번호 같은 값으로 템플릿을 변경할 때 사용된다.
   - Resources
	 기술하는 인프라를 구성하는 자원들을 종류와 옵션들을 설정하고 자원들간의 관계를 정의한다. 
   - Outputs
     스택을 생성하고 출력할 값들을 기술한다. 예를 들어 인스턴스 아이디, 가상 서버 공용 이름(Public DNS Name) 같은 것들이 있다.

2. 첫 번째 템플릿 작성
	- EC2 인스턴스를 생성하고 실행하는 텀플릿(ec2-create-instance.json)
		```json
		{
			"AWSTemplateFormatVersion": "2010-09-09",
			"Description": "create an EC2 instance of the Amazon Linux 64bit AMI",
			"Parameters": {
				"KeyName": {
					"Description": "the Key Pair for accessing to EC2 instance",
					"Type": "String",
					"Default": "mykey"
				}
			},
			"Resources": {
				"MyServer": {
					"Type": "AWS::EC2::Instance",
					"Properties": {
						"ImageId": "ami-07464b2b9929898f8",
						"InstanceType": "t2.micro",
						"KeyName": {
							"Ref": "KeyName"
						}
					}
				}
			},
			"Outputs": {
				"InstanceId": {
					"Description": "the instance's id of EC2 instance created newly",
					"Value": {
						"Ref": "MyServer"
					}
				},
				"PublicName": {
					"Description": "public name (connect via SSH as user ec2-user)",
					"Value": {
						"Fn::GetAtt": ["MyServer", "PublicDnsName"]
					}
				}
			}
		}
		```