02. Using CLI

## 02/. CLI 사용하기

​ AWS CLI는 명령줄에서 AWS를 사용할 수 있게 한다. 파이썬으로 작성된 CLI 프로그램은 맥 OS, 리눅스, 윈도우즈를 지원한다. 모든 AWS 서비스에 대한 통합 인터페이스를 제공하는 데 대부분의 출력은 JSON 포맷이다.

## 01/. CLI 설치

### 01./ 맥 OS와 리눅스

​ 기본적으로 파이썬(2.6.5이상, 2.7이상, 3.3.x 이상)과 pip가 설치되어 있어야 한다. 다음 명령어로 확인해 보자.

```shell
kickscar-macbook:~ kickscar$ python3 --version
Python 3.8.5
```

​ AWS CLI 설치는 pip를 사용하여 비교적 쉽게 설치할 수 있다.

```shell
kickscar-macbook:~ kickscar$ pip install awscli
Collecting awscli
  Downloading awscli-1.19.49-py2.py3-none-any.whl (3.6 MB)
     |████████████████████████████████| 3.6 MB 1.7 MB/s

[...]

Successfully installed PyYAML-5.4.1 awscli-1.19.49 botocore-1.20.49 colorama-0.4.3 docutils-0.15.2 jmespath-0.10.0 pyasn1-0.4.8 rsa-4.7.2 s3transfer-0.3.6 urllib3-1.26.4
kickscar-macbook:~ kickscar$
```

​ 다음 명령어로 AWS CLI 설치를 확인한다.

```shell
kickscar-macbook:~ kickscar$ aws --version
aws-cli/1.19.49 Python/3.8.5 Darwin/20.3.0 botocore/1.20.49
```

### 02./ 윈도우즈

## 02/. CLI 사용자 생성 및 CLI 설정

​ 당연하지만, CLI를 사용하려면 인증을 해야한다. 웹 콘솔에서는 루트(Root) AWS 계정을 사용했다. AWS는 이 루트 계정 사용하지 말 것을 강력히 권장한다. CLI 계정으로 새 사용자를 만드는데 사용자만 만들어도 되지만 IAM(Identity and Access Management) 서비스를 이용하여 그룹과 함께 생성하도록 하자.

1.  '보안, 자격 증명 및 규정 준수(Security, Identity & Compliance)' 아래의 IAM 서비스를 선택한다.
2.  IAM 대시보드(Dashboard) 화면의 '그룹(Group)' 메뉴를 선택한다.
3.  '새로운 그룹 생성(Create New Group)' 버튼을 클릭하여 마법사 시작한다.
4.  그룹 이름 입력하고 '다음 단계(Next Step)' 클릭한다.
    ![2f6c5663d33d04c0ac1c05c88e7be2e3.png](../../_resources/5e7ceb59713b4f43bc4a7fba41c3217c.png)
5.  정책 연결(Polcy Attach)에서 AdministratorAccess 정책을 선택하고 '다음 단계(Next Step)' 버튼을 클릭한다.
    ![c6351486db24ea291d97fba2a0028285.png](../../_resources/b631adb44e9547cf954f5ec9f0fe2fa8.png)
6.  생성 그룹의 이름과 연결 정책을 확인한 후, '그룹 생성(Create Group)' 버튼을 클릭하여 생성한다.
7.  그룹 목록에 새로 생성한 그룹 확인하자.
    ![30b08689f1489b37344f9fddbd61d6d9.png](../../_resources/36892ece24fa420cbc4b0af59b3880f1.png)
8.  사용자(User)를 추가하기 위해 IAM 대시보드(Dashboard) 화면의 '사용자(User)' 메뉴를 선택한다.
    ![ab68d3cb543648a69d6bec9bbf077e75.png](../../_resources/64d3001e7b474c9da3a3b07aa2310114.png)
9.  '사용자 추가(Add User' 버튼을 클릭하여 마법사 시작
10. 사용자 이름(mycli)과 접근 유형(Programatic Access)을 선택하고 '권한(Permission)' 버튼을 클릭한다.
    ![9d3e5203092ede6cb671aa97158a6c82.png](../../_resources/9bb0b9a0435b4a06a91a2572e0ed389a.png)
11. 앞에서 만든 그룹에 사용자를 추가 할 것이기 때문에 세 가지 옵션 중에 '그룹에 사용자 추가(Add User to Group)'와 그룹(mycliadmin)을 선택하고 '태그(Tag)' 버튼을 클릭한다.
    ![acb1eaf62fd7564349513a40cf61aea5.png](../../_resources/f960df899dae4aa48960468aa4f2c1a8.png)
12. 현재 추가하고 있는 사용자의 권한을 추적하거나 제어가 필요할 때 간단한 태그를 붙힐 수 있다. 선택 사항이니 여기서는 그냥 건너뛰고 '검토(Review)' 버튼을 클릭한다.
13. 지금 까지 진행한 내용을 검토하고 '사용자 만들기(Create User)' 버튼을 클릭하여 생성 과정을 완료하고 보안 자격 증명을 확인해 보자.
    ![8dba5e21b281d794ce65a66639886061.png](../../_resources/b6b8d8e586da49c0bdefcfa8124410a1.png)
    - '표시(Show)'를 클릭하면 Secret Access Key를 확인할 수 있다.
    - 사용자 ID, Access Key ID, Secret Access Key, 콘솔 로그인 링크 등의 정보를 담은 .csv 파일 다운로드 버튼을 클릭하여 다운로드 하자.
14. 터미널 쉘(Shell)에서 'aws configure' 명령어로 csv 파일을 참고하여 AWS CLI 프로그램에 인증 정보를 저장하도록 한다.
	```shell
    kickscar-macbook:~ kickscar$ aws configure
    AWS Access Key ID [None]: AKIAZHGRN6EYCOTYXIMS
    AWS Secret Access Key [None]: =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
    Default region name [None]: ap-northeast-2
    Default output format [None]: json
    kickscar-macbook:~ kickscar
    ```

15. 브라우저 마법사의 '닫기(Close)' 버튼을 클릭하여 과정을 완료한다.
​ CLI 작동 유무를 확인하기 위해 다음 명령을 터미널에서 다음 명령을 실행해 보자.
```shell
kickscar-macbook:~ kickscar$ aws ec2 describe-regions
{
    "Regions": [
        {
            "Endpoint": "ec2.eu-north-1.amazonaws.com",
            "RegionName": "eu-north-1",
            "OptInStatus": "opt-in-not-required"
        },
        {
            "Endpoint": "ec2.ap-south-1.amazonaws.com",
            "RegionName": "ap-south-1",
            "OptInStatus": "opt-in-not-required"
        },

[...]

        {
            "Endpoint": "ec2.us-west-2.amazonaws.com",
            "RegionName": "us-west-2",
            "OptInStatus": "opt-in-not-required"
        }
    ]
}
```

## 03/. CLI 사용

### 01. CLI 명령: aws 명령어
​ AWS CLI를 사용하기 위해 aws 명령어의 기본 형식은 다음과 같다. 서비스와 액션을 지정하고 key와 값을 지정하는 형태이다.
```shell
$ aws <service> <action> [--key value]
```

​ 예를 들어보면,
```shell
$ aws ec2 describe-instances --filters "Name=instance-type, Values=t2.micro"
{
    "Reservations": []
}
```

​ help 키워드를 사용하여 상세 도움을 받을 수 있다.
1. 이용할 수 있는 모든 서비스 나열
   ```shell
   aws help
   ```
2. 특정 서비스에서 사용할 수 있는 액션 목록 나열
   ```shell
   aws <service> help
   ```
3. 특정 서비스 액션에서 사용할 수 있는 옵션 목록을 나열
   ```shell
   aws <service> <action> help
   ```

​ --query 옵션을 사용하면 JSON를 지원하는 쿼리 언어인 JMESPath를 사용하여 결과 JSON에서 데이터만을 추출할 수 있다. 보통은 결과에서 특정 필드만 필요하기 때문에 유용한 옵션이다. 다음 예제를 가지고 설명한다.
```shell
kickscar-macbook:~ kickscar$ aws ec2 describe-regions
{
    "Regions": [
        {
            "Endpoint": "ec2.eu-north-1.amazonaws.com",
            "RegionName": "eu-north-1",
            "OptInStatus": "opt-in-not-required"
        },
        {
            "Endpoint": "ec2.ap-south-1.amazonaws.com",
            "RegionName": "ap-south-1",
            "OptInStatus": "opt-in-not-required"
        },

[...]

        {
            "Endpoint": "ec2.us-west-2.amazonaws.com",
            "RegionName": "us-west-2",
            "OptInStatus": "opt-in-not-required"
        }
    ]
}	
```

​ 전체 리전에서 첫 번째 리전의 이름을 추출하려면,
```shell
kickscar-macbook:~ kickscar$ aws ec2 describe-regions --query "Regions[0].RegionName"
"eu-north-1"
```

​ 전체 리전에서 모둔 리전의 이름만을 추출하려면,
```shell
kickscar-macbook:~ kickscar$ aws ec2 describe-regions --query "Regions[*].RegionName"
[
    "eu-north-1",
    "ap-south-1",
    "eu-west-3",
    "eu-west-2",
    "eu-west-1",
    "ap-northeast-3",
    "ap-northeast-2",
    "ap-northeast-1",
    "sa-east-1",
    "ca-central-1",
    "ap-southeast-1",
    "ap-southeast-2",
    "eu-central-1",
    "us-east-1",
    "us-east-2",
    "us-west-1",
    "us-west-2"
]
```

### 02. 가상 서버 생성

​ CLI로 가상 서버 인스턴스를 생성하고 종료하는 실습을 해보자. 인스턴스를 생성하기 위해 여러 항목이 필요한데 우선 그 항목들의 얻어내고 생성해야 한다. 다음 순서대로 진행하여 보자.

1. Description 'Amazon Linux 2 AMI 2.0.20210326.0 x86_64 HVM gp2'에 해당되는 AMI ID를 얻는다. 
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 describe-images --query "Images[?Description=='Amazon Linux 2 AMI 2.0.20210326.0 x86_64 HVM gp2'].ImageId" --output text
	ami-07464b2b9929898f8
	```

2. 기본 VPC ID를 얻는다.
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 describe-vpcs --query "Vpcs[?isDefault==true].VpcId" --output text
	vpc-27cb4b4c
	```

3. 앞 단계에서 얻어낸 VPC ID(vpc-6af57701)를 가지고 기본 VPC Subnet ID를 얻는다. 여러 서브넷을 주기떄문에 그 중 맨 앞에 것을 선택한다.
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 describe-subnets --query "(Subnets[?VpcId=='vpc-27cb4b4c'].SubnetId)[0]" --output text
	subnet-4f9f7900
	```

4. VPC ID를 가지고 보안 그룹을 생성한다.
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 create-security-group --group-name mysecuritygroup --description "My Security Group" --vpc-id vpc-27cb4b4c --output text
	sg-0e73ad2af446ee07f
	```

5. 방화벽 설정을 위해 생성된 보안 그룹에 SSH(22) 포트를 모든 주소로부터 허용한다.
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 authorize-security-group-ingress --group-id sg-0e73ad2af446ee07f --protocol tcp --port 22 --cidr 0.0.0.0/0
	```

6. 서버를 생성하고 시작한다.
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 run-instances --image-id ami-07464b2b9929898f8 --instance-type t2.micro --security-group-ids sg-0e73ad2af446ee07f --subnet-id subnet-4f9f7900 --key-name mykey --query "Instances[0].InstanceId" --output text
	i-0e65e22e1585b8c5f
	```

7. 서버가 시작할 때까지 대기한다.
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 wait instance-running --instance-ids i-0e65e22e1585b8c5f
	kickscar-macbook:~ kickscar$
	```

8. 웹 console에서  EC2 대시보드 > 인스턴스 메뉴를 선택하면 방금 생성한 인스턴스가 실행 중인 것을 확인할 수 있다.(인스턴스 ID 확인)

9. 다음 명령으로 실행된 서버의 공용 이름(DNS Name)을 확인해 보자
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 describe-instances --instance-ids i-0e65e22e1585b8c5f --query "Reservations[0].Instances[0].PublicDnsName" --output text
	ec2-3-35-209-49.ap-northeast-2.compute.amazonaws.com
	```

### 03. 가상 서버 생성 종료
​ 가상 서버를 종료하고 가상 서버의 방화벽(보안 그룹)도 삭제 할 것이다.

1. 가상 서버 종료
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 terminate-instances --instance-ids i-0e65e22e1585b8c5f --query "TerminatingInstances[0].InstanceId" --output text
	i-0e65e22e1585b8c5f
	```

2. 서버가 종료될 때까지 대기한다.
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 wait instance-terminated --instance-ids i-0e65e22e1585b8c5f
	kickscar-macbook:~ kickscar$
	```

3. 보안 그룹 삭제
	```shell
	kickscar-macbook:~ kickscar$ aws ec2 delete-security-group --group-id sg-0e73ad2af446ee07f
	```

8. 웹 console에서  EC2 대시보드 > 인스턴스 메뉴를 선택하면 인스턴스가 종료 상태를 확인하고 보안 그룹 삭제도 확인해 보자.


## 04/. CLI Shell Script
​ 가상 서버 인스턴스를 생성하고 실행하고 종료하는 명령어들을 모아 하나의 스크립트로 만들어 놓으면 다음과 같은 장점이 있다.
1. 스크립트는 재사용 가능하고 시간을 절역할 수 있다.
2. 이전 프로젝트에서 작성한 인프라 아키텍처 스크립트로 신속하게 다시 구축할 수 있다.
3. 인프라 생성을 자동화하여 배포 자동화 라인을 개선할 수 있다.

​ 쉘 스크립트(Bash)의 코드는 화면에 출력된 내용을 변수로 저장하는 부분과 약간의 입력과 제어문의 스크립트만 제외하면 앞의 실습 내용을 모아 놓은 것이다.
1. server-start.sh
```bash
#! /bin/bash -e

echo '[1] Get the ID of Amazon Linux AMI...'
AMIID=$(aws ec2 describe-images --query "Images[?Description=='Amazon Linux 2 AMI 2.0.20210326.0 x86_64 HVM gp2'].ImageId" --output text)

echo '[2] Get the default VPC ID...'
VPCID=$(aws ec2 describe-vpcs --query "Vpcs[?isDefault==true].VpcId" --output text)

echo '[3] Get the default subnet ID...'
SUBNETID=$(aws ec2 describe-subnets --query "(Subnets[?VpcId=='"$VPCID"'].SubnetId)[0]" --output text)

echo '[4] Create a security group...'
SGID=$(aws ec2 create-security-group --group-name mysecuritygroup --description "My Security Group" --vpc-id vpc-27cb4b4c --output text)

echo '[5] Allow inbound SSH connections...'
aws ec2 authorize-security-group-ingress --group-id $SGID --protocol tcp --port 22 --cidr 0.0.0.0/0

echo '[6] Create and start the server...'
INSTANCEID=$(aws ec2 run-instances --image-id $AMIID --instance-type t2.micro --security-group-ids $SGID --subnet-id $SUBNETID --key-name mykey --query "Instances[0].InstanceId" --output text)

echo "waiting for $INSTANCEID..."
aws ec2 wait instance-running --instance-ids $INSTANCEID

echo '[7] Get the public name of server...'
PUBLICNAME=$(aws ec2 describe-instances --instance-ids $INSTANCEID --query "Reservations[0].Instances[0].PublicDnsName" --output text)

echo "$INSTANCEID is accepting SSH connections under $PUBLICNAME"
echo "ssh -i mykey.pem ec2-user@$PUBLICNAME"
```
2. server-terminate.sh
```bash
#! /bin/bash -e

PUBLICNAME=''

while [ -z $PUBLICNAME ]
do
    echo -n "public name of server: "
    read PUBLICNAME
done

# Get Instance ID & Security Group ID
ARR=($(aws ec2 describe-instances --query "Reservations[*].Instances[?PublicDnsName=='"$PUBLICNAME"'].[InstanceId, SecurityGroups[0].GroupId]" --output text))
INSTANCEID=${ARR[0]}
SGID=${ARR[1]}

if [ -n "$INSTANCEID" ]
then
    # Terminate the server(silently)
    aws ec2 terminate-instances --instance-ids $INSTANCEID > /dev/null
    echo "terminating $INSTANCEID ..."
    aws ec2 wait instance-terminated --instance-ids $INSTANCEID

    # Delete the security group
    aws ec2 delete-security-group --group-id $SGID
else
   echo 'Instance doesn not exist'
fi
```
​ 두 스크립트를 실행하고 웹 콘솔에서 확인해 보자. 가상 서버 인스턴스 생성과 실행 그리고 종료가 훨씬 더 간결해졌다.
![be18aebe405497432e5aa2c91ca299f3.png](../../_resources/23497b0e6e654d1c8cc6f1f84835e7cb.png)






